# linux kernel 启动过程

我来详细解释一下 Linux 内核启动的过程，包括从按下电源键到 start_kernel 函数执行完毕的全过程。

## 按下电源键

当我们按下电源键时，计算机会开始执行 BIOS 中的程序，BIOS 会对硬件进行初始化，并加载 bootloader。bootloader 可以是 Grub、Lilo 等多种类型，其主要作用是加载内核镜像。

## bootloader 加载内核

bootloader 会在内核映像文件中找到可执行代码，并将其加载到系统的内存中。在加载过程中，bootloader 需要读取内核镜像的 header 信息，获取内核镜像的入口地址等信息。在加载完成后，bootloader 会将控制权交给内核的入口地址。

## 内核启动过程

内核启动过程的入口函数是 start_kernel()，该函数定义在 init/main.c 文件中。

start_kernel() 函数的主要工作包括：

* 初始化内核的数据结构
* 初始化 CPU 和内存管理
* 初始化中断处理机制和设备驱动
* 初始化文件系统
* 启动 init 进程

在 start_kernel() 函数中，会调用很多其他的初始化函数，例如 init_IRQ()、init_timers()、smp_init()、device_init()、vfs_caches_init() 等等。

其中比较关键的函数是 rest_init()，它会创建系统中的第一个进程 —— init 进程。在该函数中，会创建进程控制块（task_struct）、进程 0 的进程描述符（init_task）以及进程 0 的线程结构体（init_thread_union）。这些结构体的初始化包括对其内部的数据成员进行初始化、分配进程的内核栈和用户栈等操作。

当 start_kernel() 函数执行完毕后，就会进入到内核的初始化完成阶段，此时内核会进入到 idle 状态等待处理器的中断或系统调用。

## 关于 init 进程

init 程序通常是用户空间的一个进程，不是内核的一部分。在 Linux 内核中，内核启动时会先执行 start_kernel 函数，初始化一些内核数据结构和子系统，然后会执行 init 程序。init 程序的文件名通常是 /sbin/init，但也可以通过内核启动参数 init=xxx 来指定其他的 init 程序。

当内核启动时，会先尝试从启动设备上的指定位置加载 init 程序到内存中，并将其作为第一个用户空间进程运行。如果指定位置没有找到 init 程序，则内核会尝试使用一些默认的路径去查找 init 程序文件，如 /sbin/init、/etc/init、/bin/init 等。如果这些路径也没有找到 init 程序，则内核会进入 emergency mode，等待用户手动指定 init 程序的位置。

内核通过启动设备上指定的位置或默认路径去查找 init 程序，并将其加载到内存中作为第一个用户空间进程运行。

init进程通常负责系统初始化和启动用户空间的各个服务进程。在5.4.43版本的内核中，init程序主要负责以下几个方面的工作：

* 文件系统的挂载：init进程会通过读取 /etc/fstab 文件中的信息，将文件系统挂载到指定的挂载点。
* 进程管理：init进程会启动所有的系统服务进程，如systemd、udev、dbus等。此外，init进程还会启动各种用户空间的应用程序，如网络服务、数据库等。
* 系统资源的初始化：包括内存管理、进程调度、IO调度、中断处理等系统资源的初始化工作。
* 系统日志：init进程会启动 rsyslogd 服务，负责收集系统日志信息。
* 系统状态检测：init进程会检查系统状态，例如检查文件系统的状态、网络是否正常等，如果发现异常情况会尝试自动修复或者向管理员发出警告。

总之，init进程在系统启动过程中起着至关重要的作用，它是系统初始化和启动用户态服务进程的第一道关口。
